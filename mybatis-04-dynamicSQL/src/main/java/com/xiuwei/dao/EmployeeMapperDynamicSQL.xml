<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xiuwei.dao.EmployeeMapperDynamicSQL">
    <!--
    • if:判断
    • choose (when, otherwise):分支选择；带了break的switch-case
        如果带了id就用id查，如果带了lastName就用lastName查;只会进入其中一个
    • trim 字符串截取(where(封装查询条件), set(封装修改条件))
    • foreach 遍历集合
     -->
    <!-- #39 if测试： 查询条件employee里，携带了哪个查询条件，返回结果就带上这个字段的值 -->
    <select id="getEmpsByConditionIf" resultType="com.xiuwei.POJO.Employee">
         select * from tbl_employee where 1=1       <!-- 注意这个小技巧，加1=1是避免后面可能的拼接出错。如果没有1=1， 后面第一个参数也没有and开头，
                                                    那么第一个参数为null时，sql会有语法错误：select * from tbl_employee where and .... -->
         <!-- test: 判断表达式OGNL
            OGNL的使用参考官方文档，或者PPT。 和JSP的EL表达式类似。
            从参数中取值进行判断
         -->
         <if test="id!=null">
            and id=#{id}    <!-- 注意必须有and开头 -->
         </if>
        <if test="lastName!=null and lastName!=''">
            and last_name like #{lastName}
        </if>
        <if test="email!=null and email.trim()!=''">
            and email=#{email}
        </if>
        <!-- ognl会进行字符串转换， 0 与 "0" 等效-->
        <if test="gender==0 or gender==1">
            and gender=#{gender}
        </if>
    </select>

    <!-- #40 where测试： 用if的同时，用where标签，解决where 后面and/or拼接可能存在的问题。 -->
    <select id="getEmpsByConditionIfUsingWhere" resultType="com.xiuwei.POJO.Employee">
        select * from tbl_employee  <!-- 注意没有where 1=1了 -->
        <where>
            <if test="id!=null">
                id=#{id}    <!-- 注意没有and开头 -->
            </if>
            <if test="lastName!=null and lastName!=''">
                and last_name like #{lastName}
            </if>
            <if test="email!=null and email.trim()!=''">
                and email=#{email}
            </if>
            <!-- ognl会进行字符串转换， 0 与 "0" 等效-->
            <if test="gender==0 or gender==1">
                and gender=#{gender}
            </if>
        </where>
    </select>

    <!-- #42 choose测试:如果有id就用ID查，如果有lastName就用lastName查.....二者只用一个 -->
    <select id="getEmpsByConditionChoose" resultType="com.xiuwei.POJO.Employee">
        select * from tbl_employee  <!-- 注意没有where 1=1了 -->
        <where>
            <choose>
                <when test="id!=null">
                    id=#{id}
                </when>
                <when test="lastName!=null and lastName!=''">
                    last_name like #{lastName}
                </when>
                <when test="email!=null">
                    email=#{email}
                </when>
                <otherwise>
                    1=1
                </otherwise>
            </choose>
        </where>
    </select>

    <!-- #43  set与if结合的动态更新 - 传了哪列，就更新哪列，其他列不更新。(之前「mybatis-03-mapper」的'updateEmp'是全字段更新 -->
    <update id="updateEmp" parameterType="com.xiuwei.POJO.Employee">
        update tbl_employee
            <set>    <!-- 用set的好处：即时最后gender没传参，最后的sql里 where前，也不会多个逗号。 -->
                <if test="lastName!=null and lastName!=''">
                    last_name=#{lastName},    <!-- 注意后面有逗号 -->
                </if>
                <if test="email!=null and email.trim()!=''">
                    email=#{email},
                </if>
                <if test="gender==0 or gender==1">
                    gender=#{gender}
                </if>
            </set>
            <!-- 等价以下trim写法-->
            <!--
            <trim prefix="set" suffixOverrides=",">
                <if test="lastName!=null and lastName!=''">
                    last_name=#{lastName},
                </if>
                <if test="email!=null and email.trim()!=''">
                    email=#{email},
                </if>
                <if test="gender==0 or gender==1">
                    gender=#{gender}
                </if>
            </trim>
            -->
        where id=#{id}
    </update>
</mapper>